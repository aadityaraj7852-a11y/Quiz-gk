<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>MCQ → DOCX (Final All-in-One)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:Arial; margin:14px; color:#111}
  .wrap{display:flex; gap:12px; flex-wrap:wrap}
  .col{flex:1; min-width:320px; border:1px solid #ddd; padding:12px; border-radius:6px; box-sizing:border-box}
  input,textarea,select,button{font-size:14px}
  input, textarea, select { width:100%; padding:8px; margin:6px 0; box-sizing:border-box; }
  button{padding:8px 12px; margin:6px 4px; border:0; border-radius:6px; cursor:pointer}
  .btn-green{background:#0b7a3e;color:#fff}
  .btn-blue{background:#0066cc;color:#fff}
  .btn-red{background:#c0392b;color:#fff}
  .muted{color:#666; font-size:13px}
  .preview-table{width:100%; border-collapse:collapse; margin-bottom:8px}
  .preview-table td{border:1px solid #888; padding:6px; vertical-align:top}
  .controls{display:flex; gap:8px; flex-wrap:wrap}
  .small{font-size:13px; padding:6px 8px}
  #jsonArea{height:120px; font-family:monospace}
</style>
</head>
<body>
<h2>MCQ → DOCX (Final)</h2>
<p class="muted">Auto-detect Hindi → Kruti Dev, JSON paste import, Auto-save, Export DOCX (Word compatible).</p>

<div class="wrap">
  <div class="col" style="max-width:520px">
    <label>Module</label>
    <input id="module" placeholder="Module (ex: Hindi)">

    <label>Question</label>
    <textarea id="question" rows="3" placeholder="Question statement"></textarea>

    <label>Option A</label><input id="optA" placeholder="Option A">
    <label>Option B</label><input id="optB" placeholder="Option B">
    <label>Option C</label><input id="optC" placeholder="Option C">
    <label>Option D</label><input id="optD" placeholder="Option D">

    <label>Answer</label><input id="answer" placeholder="A/B/C/D">

    <label>Solution</label><textarea id="solution" rows="2" placeholder="Solution/explanation"></textarea>

    <div style="display:flex; gap:8px">
      <div style="flex:1">
        <label>Positive Marks</label><input id="pm" value="1">
      </div>
      <div style="flex:1">
        <label>Negative Marks</label><input id="nm" value="0.6">
      </div>
    </div>

    <label>Language (optional)</label>
    <select id="language">
      <option value="">auto-detect</option>
      <option value="hi">hi (force Hindi)</option>
      <option value="en">en (force English)</option>
    </select>

    <div class="controls" style="margin-top:8px">
      <button id="addBtn" class="btn-green">Add Question</button>
      <button id="clearBtn" class="small" style="background:#999;color:#fff">Clear Fields</button>
      <button id="saveJSONBtn" class="small" style="background:#444;color:#fff">Export JSON</button>
    </div>

    <hr>

    <label>JSON Import / Paste (paste valid JSON array of questions)</label>
    <textarea id="jsonArea" placeholder='Example: [{"module":"Hindi","question":"...","option":["a","b","c","d"],"answer":"A","solution":"...","pm":"1","nm":"0.6","language":"hi"}]'></textarea>
    <div class="controls">
      <button id="importJsonBtn" class="small btn-blue">Import JSON (paste & click)</button>
      <button id="clearJsonBtn" class="small" style="background:#777;color:#fff">Clear JSON</button>
    </div>

    <hr>
    <div class="controls">
      <button id="exportBtn" class="btn-blue">Export DOCX</button>
      <button id="downloadJsonBtn" class="small">Download JSON File</button>
    </div>

  </div>

  <div class="col">
    <h3>Preview</h3>
    <div id="previewArea" class="muted">No questions added.</div>

    <div style="margin-top:10px">
      <button id="removeLast" class="btn-red">Remove Last</button>
      <button id="resetAll" style="background:#7f8c8d;color:#fff">Clear All</button>
    </div>
    <p class="muted" style="margin-top:12px">Auto-save enabled — आप page refresh कर सकते हैं, data सुरक्षित रहेगा.</p>
  </div>
</div>

<script>
/* ---------- State & AutoSave ---------- */
let questions = [];
let qno = 1;
const STORAGE_KEY = "mcq_final_store_v1";

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const obj = JSON.parse(raw);
      if(Array.isArray(obj.questions)) { questions = obj.questions; qno = obj.qno || (questions.length+1); renderPreview(); }
    }
  }catch(e){ console.warn("loadState error",e); }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({questions,qno})); }

/* ---------- Helpers ---------- */
function getVal(id){ return document.getElementById(id).value.trim(); }
function setVal(id,v){ document.getElementById(id).value = v || ""; }
function isHindiText(s){ if(!s) return false; return /[\u0900-\u097F]/.test(s); }

/* ---------- Add / UI ---------- */
document.getElementById('addBtn').addEventListener('click', ()=>{
  const question = getVal('question');
  if(!question){ alert('Question डालो।'); return; }

  // determine language: user select overrides auto-detect
  let lang = getVal('language');
  if(!lang){
    // auto-detect: if any option or question has devanagari => hi
    if(isHindiText(question) || isHindiText(getVal('optA')) || isHindiText(getVal('optB')) || isHindiText(getVal('optC')) || isHindiText(getVal('optD')) || isHindiText(getVal('solution'))){
      lang = "hi";
    } else lang = "en";
  }

  const item = {
    module: getVal('module') || "General",
    questionno: qno++,
    question,
    type: "mcq",
    option: [ getVal('optA'), getVal('optB'), getVal('optC'), getVal('optD') ],
    answer: getVal('answer'),
    solution: getVal('solution'),
    pm: getVal('pm') || "1",
    nm: getVal('nm') || "0",
    language: lang
  };
  questions.push(item);
  saveState();
  renderPreview();
  clearFormFields();
});

document.getElementById('clearBtn').addEventListener('click', clearFormFields);
function clearFormFields(){
  setVal('module',''); setVal('question','');
  setVal('optA',''); setVal('optB',''); setVal('optC',''); setVal('optD','');
  setVal('answer',''); setVal('solution',''); setVal('pm','1'); setVal('nm','0.6'); document.getElementById('language').value = "";
}

/* ---------- Preview ---------- */
function renderPreview(){
  const area = document.getElementById('previewArea');
  area.innerHTML = "";
  if(questions.length===0){ area.innerHTML = '<div class="muted">No questions added.</div>'; return; }

  questions.forEach(q=>{
    const tbl = document.createElement('table');
    tbl.className = "preview-table";
    tbl.style.borderCollapse = "collapse";

    function addRow(name,val){
      const tr = document.createElement('tr');
      const td1 = document.createElement('td');
      td1.textContent = name;
      td1.style.background = "white";
      td1.style.fontWeight = "600";
      td1.style.width = "140px";
      const td2 = document.createElement('td');
      td2.textContent = val;
      td2.style.background = "#ffe39c";
      tr.appendChild(td1); tr.appendChild(td2);
      tbl.appendChild(tr);
    }

    addRow("Module", q.module);
    addRow("questionno", q.questionno);
    addRow("Question", q.question);
    addRow("Type", q.type);
    addRow("option", q.option[0]||"");
    addRow("option", q.option[1]||"");
    addRow("option", q.option[2]||"");
    addRow("option", q.option[3]||"");
    addRow("answer", q.answer||"");
    addRow("Solution", q.solution||"");
    addRow("Positive Marks", q.pm);
    addRow("Negative Marks", q.nm);
    addRow("language", q.language||"");

    area.appendChild(tbl);
  });
}

/* ---------- Remove / Reset ---------- */
document.getElementById('removeLast').addEventListener('click', ()=>{
  if(questions.length===0) return alert("Kuch bhi nahi hai remove karne ke liye");
  questions.pop();
  saveState();
  renderPreview();
});
document.getElementById('resetAll').addEventListener('click', ()=>{
  if(!confirm("सारे questions हटाने हैं?")) return;
  questions=[]; qno=1; saveState(); renderPreview();
});

/* ---------- JSON Import / Export ---------- */
document.getElementById('importJsonBtn').addEventListener('click', ()=>{
  const txt = document.getElementById('jsonArea').value.trim();
  if(!txt) return alert("JSON paste करो पहले");
  try{
    const arr = JSON.parse(txt);
    if(!Array.isArray(arr)) return alert("JSON array होना चाहिए");
    // validate and map minimal fields
    arr.forEach(it=>{
      const item = {
        module: it.module || "General",
        questionno: qno++,
        question: it.question || "",
        type: "mcq",
        option: Array.isArray(it.option) ? it.option.concat([]).slice(0,4) : [it.optA||"",it.optB||"",it.optC||"",it.optD||""],
        answer: it.answer || "",
        solution: it.solution || "",
        pm: (it.pm!=null) ? String(it.pm) : "1",
        nm: (it.nm!=null) ? String(it.nm) : "0",
        language: it.language || (isHindiText(it.question || "") ? "hi" : "en")
      };
      questions.push(item);
    });
    saveState();
    renderPreview();
    alert("Imported " + arr.length + " questions");
  }catch(e){ alert("Invalid JSON: " + e.message); }
});

document.getElementById('clearJsonBtn').addEventListener('click', ()=> { document.getElementById('jsonArea').value = ""; });

document.getElementById('saveJSONBtn').addEventListener('click', ()=>{
  if(questions.length===0) return alert("Koi question nhi hai export karne ke liye");
  const data = JSON.stringify(questions, null, 2);
  const blob = new Blob([data],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = "mcq_export.json"; a.click();
  setTimeout(()=> URL.revokeObjectURL(url),3000);
});

document.getElementById('downloadJsonBtn').addEventListener('click', ()=>{
  if(questions.length===0) return alert("No questions");
  const data = JSON.stringify(questions, null, 2);
  const blob = new Blob([data],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = "mcq_bank.json"; a.click();
  setTimeout(()=> URL.revokeObjectURL(url),3000);
});

/* ---------- DOCX Builder Helpers ---------- */
function xmlEscape(s){
  if(s==null) return "";
  return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

// font run for Kruti Dev if needed
function fontRunIfHindi(lang, text){
  // lang param from question; also detect if text has hindi
  const needs = (lang==="hi") || isHindiText(text);
  if(!needs) return "";
  // using common Kruti Dev font name
  return `<w:rPr><w:rFonts w:ascii="Kruti Dev 010" w:hAnsi="Kruti Dev 010" w:cs="Kruti Dev 010"/></w:rPr>`;
}

function makeRowXml(name, value, lang){
  const fontTag = fontRunIfHindi(lang, value);
  return `
<w:tr>
  <w:tc>
    <w:tcPr><w:shd w:fill="FFFFFF"/><w:tcBorders>
      <w:top w:val="single"/><w:left w:val="single"/><w:bottom w:val="single"/><w:right w:val="single"/>
    </w:tcBorders></w:tcPr>
    <w:p><w:r><w:t>${xmlEscape(name)}</w:t></w:r></w:p>
  </w:tc>

  <w:tc>
    <w:tcPr><w:shd w:fill="FFE39C"/><w:tcBorders>
      <w:top w:val="single"/><w:left w:val="single"/><w:bottom w:val="single"/><w:right w:val="single"/>
    </w:tcBorders></w:tcPr>
    <w:p><w:r>${fontTag}<w:t>${xmlEscape(value)}</w:t></w:r></w:p>
  </w:tc>
</w:tr>`;
}

function buildQuestionTableXml(q){
  let rows = "";
  rows += makeRowXml("Module", q.module, q.language);
  rows += makeRowXml("questionno", q.questionno, q.language);
  rows += makeRowXml("Question", q.question, q.language);
  rows += makeRowXml("Type", q.type, q.language);
  rows += makeRowXml("option", q.option[0] || "", q.language);
  rows += makeRowXml("option", q.option[1] || "", q.language);
  rows += makeRowXml("option", q.option[2] || "", q.language);
  rows += makeRowXml("option", q.option[3] || "", q.language);
  rows += makeRowXml("answer", q.answer || "", q.language);
  rows += makeRowXml("Solution", q.solution || "", q.language);
  rows += makeRowXml("Positive Marks", q.pm || "", q.language);
  rows += makeRowXml("Negative Marks", q.nm || "", q.language);
  rows += makeRowXml("language", q.language || "", q.language);

  return `<w:tbl>
  <w:tblPr><w:tblBorders>
    <w:top w:val="single"/><w:left w:val="single"/><w:right w:val="single"/><w:bottom w:val="single"/>
    <w:insideH w:val="single"/><w:insideV w:val="single"/>
  </w:tblBorders></w:tblPr>
  ${rows}
</w:tbl>`;
}

function buildDocumentXml(){
  let body = "";
  questions.forEach(q => body += buildQuestionTableXml(q));
  return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:body>
    ${body}
    <w:p/><w:sectPr/>
  </w:body>
</w:document>`;
}

/* ---------- Stable ZIP builder (correct offsets) ---------- */
function buildZipBlob(files){
  function s2u(s){ return new TextEncoder().encode(s); }
  const localParts = [];
  const centralParts = [];
  let offset = 0;

  for(const name in files){
    const content = files[name];
    const data = s2u(content);
    const fname = s2u(name);
    const size = data.length;

    // local header
    const lh = new Uint8Array(30 + fname.length);
    lh.set([0x50,0x4b,0x03,0x04],0);
    lh.set([20,0],4);
    lh.set([0,0],6);
    lh.set([0,0],8);
    lh.set([0,0,0,0],10); // mod time/date
    lh.set([0,0,0,0],14); // crc placeholder (0)
    lh.set([size & 0xff, (size>>8)&0xff, (size>>16)&0xff, (size>>24)&0xff],18);
    lh.set([size & 0xff, (size>>8)&0xff, (size>>16)&0xff, (size>>24)&0xff],22);
    lh.set([fname.length & 0xff, (fname.length>>8)&0xff],26);
    lh.set(fname,30);

    localParts.push({lh,data});
    offset += lh.length + data.length;

    // central header
    const ch = new Uint8Array(46 + fname.length);
    ch.set([0x50,0x4b,0x01,0x02],0);
    ch.set([20,0],4); ch.set([20,0],6);
    ch.set([0,0],8); ch.set([0,0],10);
    ch.set([0,0,0,0],12);
    ch.set([0,0,0,0],16); // crc placeholder
    ch.set([size & 0xff, (size>>8)&0xff, (size>>16)&0xff, (size>>24)&0xff],20);
    ch.set([size & 0xff, (size>>8)&0xff, (size>>16)&0xff, (size>>24)&0xff],24);
    ch.set([fname.length & 0xff, (fname.length>>8)&0xff],28);
    ch.set([0,0,0,0],30);
    ch.set([0,0],36);
    ch.set([0,0,0,0],38);
    // set offset to the start of local header for this file:
    const localStart = offset - (lh.length + data.length);
    ch.set([localStart & 0xff, (localStart>>8)&0xff, (localStart>>16)&0xff, (localStart>>24)&0xff],42);
    ch.set(fname,46);
    centralParts.push(ch);
  }

  // assemble
  let totalLocal = 0;
  localParts.forEach(it => totalLocal += it.lh.length + it.data.length);
  let centralSize = 0; centralParts.forEach(c => centralSize += c.length);
  const eocdSize = 22;
  const out = new Uint8Array(totalLocal + centralSize + eocdSize);
  let p = 0;
  localParts.forEach(it => { out.set(it.lh, p); p += it.lh.length; out.set(it.data, p); p += it.data.length; });
  const cdStart = p;
  centralParts.forEach(c => { out.set(c, p); p += c.length; });
  const cdSize = p - cdStart;

  // EOCD
  out.set([0x50,0x4b,0x05,0x06], p); p+=4;
  out.set([0,0], p); p+=2;
  out.set([0,0], p); p+=2;
  const entries = centralParts.length;
  out.set([ entries & 0xff, (entries>>8)&0xff ], p); p+=2;
  out.set([ entries & 0xff, (entries>>8)&0xff ], p); p+=2;
  out.set([ cdSize & 0xff, (cdSize>>8)&0xff, (cdSize>>16)&0xff, (cdSize>>24)&0xff ], p); p+=4;
  out.set([ cdStart & 0xff, (cdStart>>8)&0xff, (cdStart>>16)&0xff, (cdStart>>24)&0xff ], p); p+=4;
  out.set([0,0], p); p+=2;

  return new Blob([out], {type:"application/zip"});
}

/* ---------- DOCX Export ---------- */
document.getElementById('exportBtn').addEventListener('click', ()=>{
  if(questions.length===0) return alert("पहले प्रश्न जोड़ो!");
  const docXml = buildDocumentXml();
  const files = {
    "[Content_Types].xml": `<?xml version="1.0" encoding="UTF-8"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
</Types>`,
    "_rels/.rels": `<?xml version="1.0"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"/>`,
    "word/_rels/document.xml.rels": `<?xml version="1.0"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"/>`,
    "word/document.xml": docXml
  };

  const zipBlob = buildZipBlob(files);
  const url = URL.createObjectURL(zipBlob);
  const a = document.createElement('a'); a.href = url; a.download = "mcq_export.docx"; a.click();
  setTimeout(()=> URL.revokeObjectURL(url),3000);
});

/* ---------- Init ---------- */
loadState();
</script>
</body>
</html>
