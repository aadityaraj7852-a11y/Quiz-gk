<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>MCQ → DOCX (Images + Tables) FINAL</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:Arial;margin:14px}
  .wrap{display:flex;gap:12px;flex-wrap:wrap}
  .col{flex:1;min-width:320px;border:1px solid #ccc;padding:12px;border-radius:6px}
  input,textarea,select{width:100%;padding:8px;margin:6px 0}
  button{padding:8px 14px;margin:4px;border:none;border-radius:6px;cursor:pointer}
  .btn-green{background:#0b7a3e;color:#fff}
  .btn-blue{background:#0066cc;color:#fff}
  .btn-red{background:#c0392b;color:#fff}
  .preview-table{width:100%;border-collapse:collapse;margin-bottom:10px}
  .preview-table td{border:1px solid #444;padding:6px}
  .yellow{background:#ffe39c}
  .white{background:#fff}
  .muted{font-size:13px;color:#666}
  img.preview-img{max-width:140px; margin-top:6px; display:block}
</style>
</head>
<body>

<h2>MCQ → DOCX (Images + Table Format)</h2>
<p class="muted">Yellow Right + White Left Table — Images allowed everywhere — DOCX Export</p>

<div class="wrap">
  <div class="col">

    <label>Module</label>
    <input id="module">
    <input type="file" id="moduleImg" accept="image/*">

    <label>Question</label>
    <textarea id="question" rows="3"></textarea>
    <input type="file" id="questionImg" accept="image/*">

    <label>Option A</label>
    <input id="optA">
    <input type="file" id="imgA" accept="image/*">

    <label>Option B</label>
    <input id="optB">
    <input type="file" id="imgB" accept="image/*">

    <label>Option C</label>
    <input id="optC">
    <input type="file" id="imgC" accept="image/*">

    <label>Option D</label>
    <input id="optD">
    <input type="file" id="imgD" accept="image/*">

    <label>Answer</label>
    <input id="answer">

    <label>Solution</label>
    <textarea id="solution" rows="2"></textarea>
    <input type="file" id="solImg" accept="image/*">

    <label>Positive Marks</label>
    <input id="pm" value="1">

    <label>Negative Marks</label>
    <input id="nm" value="0.6">

    <label>Language (optional)</label>
    <select id="language">
      <option value="en">en</option>
      <option value="hi">hi</option>
    </select>

    <button id="addBtn" class="btn-green">Add Question</button>
    <button id="clearBtn">Clear Fields</button>
    <hr>

    <label>JSON Import</label>
    <textarea id="jsonArea" style="height:100px"></textarea>
    <button id="importJsonBtn" class="btn-blue">Import</button>
    <button id="exportJsonBtn">Download JSON</button>

    <hr>

    <button id="exportBtn" class="btn-blue">Export DOCX</button>

  </div>

  <div class="col">
    <h3>Preview</h3>
    <div id="previewArea" class="muted"></div>
    <button id="removeLast" class="btn-red">Remove Last</button>
    <button id="clearAll">Clear All</button>
  </div>
</div>

<script>
/* ------------------------------------------------------------
   STORAGE + STATE
------------------------------------------------------------ */
let questions = [];
let qno = 1;
const KEY = "mcq_image_docx_v1";

function loadState(){
  const t = localStorage.getItem(KEY);
  if(t){
    const obj = JSON.parse(t);
    questions = obj.questions;
    qno = obj.qno;
    renderPreview();
  }
}
function saveState(){ localStorage.setItem(KEY, JSON.stringify({questions,qno})); }

/* ------------------------------------------------------------
   HELPER to read image as base64
------------------------------------------------------------ */
function readImage(file){
  return new Promise(resolve=>{
    if(!file) return resolve(null);
    const fr = new FileReader();
    fr.onload = ()=> resolve(fr.result);
    fr.readAsDataURL(file);
  });
}

/* ------------------------------------------------------------
   ADD QUESTION
------------------------------------------------------------ */
document.getElementById("addBtn").onclick = async ()=>{
  const item = {
    module: document.getElementById("module").value,
    question: document.getElementById("question").value,
    option: [
      document.getElementById("optA").value,
      document.getElementById("optB").value,
      document.getElementById("optC").value,
      document.getElementById("optD").value
    ],
    answer: document.getElementById("answer").value,
    solution: document.getElementById("solution").value,
    pm: document.getElementById("pm").value,
    nm: document.getElementById("nm").value,
    language: document.getElementById("language").value,
    questionno: qno++,
    images: {
      module: await readImage(document.getElementById("moduleImg").files[0]),
      question: await readImage(document.getElementById("questionImg").files[0]),
      A: await readImage(document.getElementById("imgA").files[0]),
      B: await readImage(document.getElementById("imgB").files[0]),
      C: await readImage(document.getElementById("imgC").files[0]),
      D: await readImage(document.getElementById("imgD").files[0]),
      sol: await readImage(document.getElementById("solImg").files[0])
    }
  };

  questions.push(item);
  saveState();
  renderPreview();
};

/* ------------------------------------------------------------
   CLEAR FORM
------------------------------------------------------------ */
document.getElementById("clearBtn").onclick = ()=>{
  document.querySelectorAll("input,textarea").forEach(e=>{ if(e.type!=="file") e.value=""; });
};

/* ------------------------------------------------------------
   PREVIEW
------------------------------------------------------------ */
function renderPreview(){
  const p = document.getElementById("previewArea");
  p.innerHTML = "";
  questions.forEach(q=>{
    const tbl = document.createElement("table");
    tbl.className="preview-table";

    function addRow(name,val,img){
      const tr = document.createElement("tr");

      const td1=document.createElement("td");
      td1.textContent=name;
      td1.className="white";

      const td2=document.createElement("td");
      td2.className="yellow";
      td2.innerHTML=val;

      if(img){
        const im=document.createElement("img");
        im.src=img;
        im.className="preview-img";
        td2.appendChild(im);
      }

      tr.appendChild(td1);
      tr.appendChild(td2);
      tbl.appendChild(tr);
    }

    addRow("Module",q.module,q.images.module);
    addRow("questionno",q.questionno,null);
    addRow("Question",q.question,q.images.question);
    addRow("Type","mcq",null);
    addRow("option",q.option[0],q.images.A);
    addRow("option",q.option[1],q.images.B);
    addRow("option",q.option[2],q.images.C);
    addRow("option",q.option[3],q.images.D);
    addRow("answer",q.answer,null);
    addRow("Solution",q.solution,q.images.sol);
    addRow("Positive Marks",q.pm,null);
    addRow("Negative Marks",q.nm,null);
    addRow("language",q.language,null);

    p.appendChild(tbl);
  });
}

/* ------------------------------------------------------------
   REMOVE / CLEAR
------------------------------------------------------------ */
document.getElementById("removeLast").onclick=()=>{
  questions.pop();
  saveState(); renderPreview();
};
document.getElementById("clearAll").onclick=()=>{
  questions=[]; qno=1; saveState(); renderPreview();
};

/* ------------------------------------------------------------
   JSON Import/Export
------------------------------------------------------------ */
document.getElementById("importJsonBtn").onclick=()=>{
  try{
    const arr=JSON.parse(document.getElementById("jsonArea").value);
    arr.forEach(x=>{ x.questionno=qno++; questions.push(x); });
    saveState(); renderPreview();
  }catch(e){ alert("Invalid JSON"); }
};
document.getElementById("exportJsonBtn").onclick=()=>{
  const blob = new Blob([JSON.stringify(questions,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="mcq.json"; a.click();
};

/* ------------------------------------------------------------
   DOCX EXPORT (with images)
------------------------------------------------------------ */
document.getElementById("exportBtn").onclick=async ()=>{

  const mediaFiles={};
  let rels=""; 
  let relId=1;

  function addImage(base64){
    if(!base64) return "";
    const png = base64.split(",")[1];
    const fname = "image"+(Object.keys(mediaFiles).length+1)+".png";
    mediaFiles[fname]=png;
    const rid="rId"+(relId++);
    rels += `<Relationship Id="${rid}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="media/${fname}"/>`;
    return rid;
  }

  function makeRowXML(name,val,imgBase){
    let imgXML="";
    if(imgBase){
      const rid = addImage(imgBase);
      imgXML = `
        <w:p>
          <w:r>
            <w:drawing>
              <wp:inline xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing">
                <wp:extent cx="4500000" cy="3000000"/>
                <a:graphic xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main">
                  <a:graphicData uri="http://schemas.openxmlformats.org/drawingml/2006/picture">
                    <pic:pic xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture">
                      <pic:blipFill>
                        <a:blip r:embed="${rid}"/>
                        <a:stretch><a:fillRect/></a:stretch>
                      </pic:blipFill>
                      <pic:spPr><a:prstGeom prst="rect"/></pic:spPr>
                    </pic:pic>
                  </a:graphicData>
                </a:graphic>
              </wp:inline>
            </w:drawing>
          </w:r>
        </w:p>`;
    }

    return `
<w:tr>
  <w:tc><w:p><w:r><w:t>${name}</w:t></w:r></w:p></w:tc>
  <w:tc>
    <w:p><w:r><w:t>${val}</w:t></w:r></w:p>
    ${imgXML}
  </w:tc>
</w:tr>`;
  }

  let bodyXML = "";
  questions.forEach(q=>{
    bodyXML += `<w:tbl>`;
    bodyXML += makeRowXML("Module",q.module,q.images.module);
    bodyXML += makeRowXML("questionno",q.questionno,null);
    bodyXML += makeRowXML("Question",q.question,q.images.question);
    bodyXML += makeRowXML("Type","mcq",null);
    bodyXML += makeRowXML("option",q.option[0],q.images.A);
    bodyXML += makeRowXML("option",q.option[1],q.images.B);
    bodyXML += makeRowXML("option",q.option[2],q.images.C);
    bodyXML += makeRowXML("option",q.option[3],q.images.D);
    bodyXML += makeRowXML("answer",q.answer,null);
    bodyXML += makeRowXML("Solution",q.solution,q.images.sol);
    bodyXML += makeRowXML("Positive Marks",q.pm,null);
    bodyXML += makeRowXML("Negative Marks",q.nm,null);
    bodyXML += makeRowXML("language",q.language,null);
    bodyXML += `</w:tbl>`;
  });

  const documentXML = `<?xml version="1.0" encoding="UTF-8"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
            xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
  <w:body>
    ${bodyXML}
  </w:body>
</w:document>`;

  const relsXML = `<?xml version="1.0"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
${rels}
</Relationships>`;

  const files = {
    "[Content_Types].xml": `<?xml version="1.0"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Default Extension="png" ContentType="image/png"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
</Types>`,
    "_rels/.rels": `<?xml version="1.0"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`,
    "word/document.xml": documentXML,
    "word/_rels/document.xml.rels": relsXML
  };

  for(const fname in mediaFiles){
    files["word/media/"+fname] = atob(mediaFiles[fname]);
  }

  const zipBlob = buildZip(files);
  const url = URL.createObjectURL(zipBlob);
  const a=document.createElement("a");
  a.href=url;
  a.download="questions.docx";
  a.click();
};

/* ZIP Builder */
function buildZip(files){
  function encode(str){ return new TextEncoder().encode(str); }

  let parts=[];
  let central=[];
  let offset=0;

  for(const path in files){
    const content = (typeof files[path]==="string")? encode(files[path]) : new Uint8Array(files[path].split("").map(c=>c.charCodeAt(0)));
    const name = encode(path);

    const lh = new Uint8Array(30 + name.length);
    lh.set([0x50,0x4b,0x03,0x04],0);
    lh.set([20,0],4);
    lh.set([0,0],6);
    lh.set([0,0],8);
    lh.set([0,0,0,0],10);
    lh.set([0,0,0,0],14);
    lh.set([content.length,0,0,0],18);
    lh.set([content.length,0,0,0],22);
    lh[26]=name.length;

    lh.set(name,30);

    parts.push(lh,content);

    const ch = new Uint8Array(46 + name.length);
    ch.set([0x50,0x4b,0x01,0x02],0);
    ch.set([20,0],4);
    ch.set([20,0],6);
    ch[28]=name.length;

    const rel = offset;
    ch[42]=rel & 0xff;

    ch.set(name,46);
    central.push(ch);

    offset += lh.length + content.length;
  }

  let sizeLocal=offset;
  let sizeCentral=central.reduce((a,b)=>a+b.length,0);

  const eocd = new Uint8Array(22);
  eocd.set([0x50,0x4b,0x05,0x06],0);
  const entries = central.length;
  eocd[10]=entries; eocd[12]=entries;
  eocd[16]=sizeCentral & 0xff;
  eocd[20]=sizeLocal & 0xff;

  return new Blob([...parts,...central,[eocd]], {type:"application/zip"});
}

loadState();
</script>
</body>
</html>
